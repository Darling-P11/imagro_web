<div class="table-container">
  <!-- üîÑ Spinner de carga mientras se cargan las contribuciones -->
  <div *ngIf="isLoading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Cargando contribuciones...</p>
  </div>

  <!-- ‚úÖ Tabla de contribuciones -->
  <table *ngIf="!isLoading">
    <thead>
      <tr>
        <th>Nombre del Usuario</th>
        <th>Fecha de Env√≠o</th>
        <th>Cantidad de Cultivos</th>
        <th>Estado</th>
        <th>Cantidad de Im√°genes</th>
        <th>Configuraci√≥n</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr
        *ngFor="let contribution of contributions"
        (click)="selectContribution(contribution)"
      >
        <td>{{ contribution.nombreUsuario }}</td>
        <!--  Nombre del usuario -->
        <td>
          {{
            contribution.contributionDetails.fecha_contribucion | date : "short"
          }}
        </td>
        <!--  Fecha formateada -->
        <td>{{ contribution.configuracionCompleta.cultivos.length }}</td>
        <!--  Cantidad de cultivos -->
        <td>{{ contribution.configuracionCompleta.estado }}</td>
        <!--  Estado -->
        <td>{{ contribution.contributionDetails.cantidad_imagenes }}</td>
        <!--  Cantidad de im√°genes -->
        <td>
          <!-- Bot√≥n para ver configuraci√≥n espec√≠fica -->
          <button class="config-btn" (click)="viewConfiguration(contribution)">
            Ver Configuraci√≥n
          </button>
        </td>
        <td>
          <!-- Bot√≥n Aceptar con flujo de confirmaci√≥n -->
          <button
            class="action-button accept"
            [disabled]="rejectingContributionId === contribution.id"
            (click)="openAcceptConfirm(contribution)"
          >
            <ng-container
              *ngIf="
                rejectingContributionId === contribution.id &&
                  currentAction === 'aceptado';
                else normalAccept
              "
            >
              <div class="button-spinner"></div>
              Aceptando...
            </ng-container>
            <ng-template #normalAccept>Aceptar</ng-template>
          </button>

          <!-- Bot√≥n Rechazar con confirmaci√≥n -->
          <button
            class="action-button reject"
            [disabled]="rejectingContributionId === contribution.id"
            (click)="openRejectConfirm(contribution)"
          >
            <ng-container
              *ngIf="
                rejectingContributionId === contribution.id &&
                  currentAction === 'rechazado';
                else normalReject
              "
            >
              <div class="button-spinner"></div>
              Rechazando...
            </ng-container>
            <ng-template #normalReject>Rechazar</ng-template>
          </button>

          <!-- Bot√≥n Visualizar -->
          <button
            class="action-button view"
            [disabled]="rejectingContributionId !== null"
            (click)="viewContribution(contribution)"
          >
            Visualizar
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!--  Modal de Configuraci√≥n -->

<div *ngIf="showModal" class="modal-overlay">
  <div class="modal-content">
    <h2>üìã Resumen de tu configuraci√≥n</h2>
    <!--  T√≠tulo fijo -->
    <div *ngIf="selectedConfigData">
      <div
        *ngFor="let cultivo of getCultivos(selectedConfigData)"
        class="cultivo-container"
      >
        <h3 class="cultivo-title">Cultivo: {{ cultivo }}</h3>
        <div *ngFor="let tipo of getTiposCultivo(selectedConfigData[cultivo])">
          <p class="tipo-cultivo">üè∑Ô∏è {{ tipo }}</p>
          <p class="estado">
            Estado: {{ selectedConfigData[cultivo][tipo].estado }}
          </p>
          <p class="enfermedades">
            Enfermedades:
            {{
              selectedConfigData[cultivo][tipo].enfermedades?.join(", ") ||
                "Sin enfermedades"
            }}
          </p>
        </div>
      </div>
    </div>
    <button (click)="closeModal()" class="close-modal">Cerrar</button>
  </div>
</div>

<!--  Modal de Visualizaci√≥n de Im√°genes -->

<div *ngIf="isVisualizeModalVisible" class="modal-overlay">
  <div class="modal-content-large">
    <!--  Bot√≥n de cerrar -->
    <button class="close-button" (click)="closeVisualizeModal()">‚ùå</button>

    <!--  T√≠tulo centrado -->
    <h2>üñºÔ∏è Visualizaci√≥n de Im√°genes</h2>

    <!--  Secciones organizadas -->
    <div
      *ngFor="let cultivo of getCultivosFromImages()"
      class="cultivo-section"
    >
      <h3>{{ cultivo }}</h3>

      <div
        *ngFor="let tipo of getTiposFromImages(cultivo)"
        class="tipo-section"
      >
        <h4>Tipo: {{ tipo }}</h4>

        <div
          *ngFor="let estado of getEstadosFromImages(cultivo, tipo)"
          class="estado-section"
        >
          <h5>Estado: {{ estado }}</h5>

          <div
            *ngFor="
              let enfermedad of getEnfermedadesFromImages(cultivo, tipo, estado)
            "
            class="enfermedad-section"
          >
            <h6>Enfermedad: {{ enfermedad }}</h6>

            <!-- ‚úÖ Mosaico de im√°genes -->
            <div class="image-grid">
              <ng-container
                *ngFor="
                  let img of filterImagesByCompleteCriteria(
                    cultivo,
                    tipo,
                    estado,
                    enfermedad
                  )
                "
              >
                <div class="image-wrapper">
                  <img
                    [src]="img.url"
                    alt="Imagen de contribuci√≥n"
                    class="image-preview-grid"
                    (load)="onImageLoad(img)"
                    (error)="onImageError(img)"
                    [class.loaded]="img.loaded"
                  />
                  <div class="mini-spinner" *ngIf="!img.loaded"></div>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ Bot√≥n de cerrar en la parte inferior -->
    <button (click)="closeVisualizeModal()" class="close-modal">Cerrar</button>
  </div>
</div>

<!--  Modal de carga mientras se visualizan im√°genes -->
<div *ngIf="isLoadingImages" class="modal-overlay">
  <div class="loading-spinner">
    <div class="spinner"></div>
    <p>Cargando im√°genes...</p>
  </div>
</div>

<!--  Modal de confirmaci√≥n para rechazar -->
<div *ngIf="showRejectConfirmModal" class="modal-overlay">
  <div class="modal-content">
    <h2>¬øEst√°s seguro de rechazar esta contribuci√≥n?</h2>
    <p>Esta acci√≥n mover√° las im√°genes a la secci√≥n de rechazadas.</p>
    <div
      style="
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
      "
    >
      <button class="action-button reject" (click)="confirmReject()">
        S√≠, rechazar
      </button>
      <button class="action-button view" (click)="cancelReject()">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!--  Modal de carga mientras se procesa el rechazo -->
<div *ngIf="isProcessingRejection" class="modal-overlay">
  <div class="loading-spinner">
    <div class="spinner"></div>
    <p>{{ currentProcessingText }}</p>

  </div>
</div>

<!--  Modal mientras se actualiza la tabla tras aceptar o rechazar -->
<div *ngIf="isUpdatingTable" class="modal-overlay">
  <div class="loading-spinner">
    <div class="spinner"></div>
    <p>Actualizando contribuciones...</p>
  </div>
</div>

<!-- ‚úÖ Modal de confirmaci√≥n para aceptar -->
<div *ngIf="showAcceptConfirmModal" class="modal-overlay">
  <div class="modal-content">
    <h2>¬øAceptar esta contribuci√≥n?</h2>
    <p>Esta acci√≥n mover√° la informaci√≥n a la secci√≥n de aprobadas.</p>
    <div
      style="
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
      "
    >
      <button class="action-button accept" (click)="confirmAccept()">
        S√≠, aceptar
      </button>
      <button class="action-button view" (click)="cancelAccept()">
        Cancelar
      </button>
    </div>
  </div>
</div>
